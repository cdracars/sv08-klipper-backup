[gcode_macro HEAT_SOAK_CHAMBER]
description: Heat bed to target and soak - press CANCEL_HEAT_SOAK to stop
gcode:
  {% set soaktemp = params.SOAK_BED_TEMPERATURE|default(100)|int %}
  {% set soaktime = params.SOAK_DURATION_SECONDS|default(900)|int %}
  {% set tick = 30 %}
  {% set num_ticks = (soaktime // tick)|int %}
  
  M117 Heating bed to {soaktemp}Â°C...
  M118 Heating bed to {soaktemp}Â°C...
  M190 S{soaktemp}  ; Wait until bed reaches soaktemp
  
  {% if printer.toolhead.homed_axes != "xyz" %}
    G28
  {% endif %}
  G90
  G1 Z5 F6000
  
  M117 Starting heat soak for {soaktime}s...
  M118 Starting heat soak for {soaktime}s...
  M118 Press CANCEL_HEAT_SOAK button to stop early
  
  ; Count DOWN from soak time with cancel checking
  {% for i in range(num_ticks, 0, -1) %}
    {% set remaining = i * tick %}
    
    ; Check for user cancellation at start of each cycle
    {% if printer.print_stats.state == "cancelled" %}
      M118 Heat soak cancelled by user
      M117 Heat soak cancelled
      {% break %}
    {% endif %}
    
    M117 Soaking... {remaining}s left (CANCEL_HEAT_SOAK to stop)
    M118 Soaking... {remaining}s left
    G1 X{(i % 2) * 5} F3000
    
    ; 30 seconds of 1-second delays with periodic cancel checking
    {% for second in range(tick) %}
      ; Check for cancel every 10 seconds for good responsiveness
      {% if second % 10 == 0 %}
        {% if printer.print_stats.state == "cancelled" %}
          M118 Heat soak cancelled
          M117 Heat soak cancelled
          {% break %}
        {% endif %}
      {% endif %}
      
      G4 P1000  ; 1 second delay
    {% endfor %}
  {% endfor %}
  
  ; Only show completion if we didn't cancel
  {% if printer.print_stats.state != "cancelled" %}
    M117 Heat soak complete!
    M118 Heat soak complete!
    BEEP
    G4 P300
    BEEP
    G4 P600
    BEEP
  {% endif %}

[gcode_macro CANCEL_HEAT_SOAK]
description: ðŸ›‘ Cancel running heat soak operation
gcode:
  M118 ðŸ›‘ Cancelling heat soak...
  M117 ðŸ›‘ Heat soak cancelled
  ; Trigger the cancel state that the heat soak macro checks for
  SET_PRINT_STATS_INFO STATE=cancelled