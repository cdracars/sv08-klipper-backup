# Combined Heat Soak and Delay Test Macros for Klipper

# ============================================================================
# DELAY TESTING MACROS
# ============================================================================

[gcode_macro TEST_G4_SECONDS]
description: Test G4 with seconds parameter
gcode:
    M118 TEST_G4_SECONDS: Starting at {printer.system_stats.print_time}
    M117 G4 S test starting...
    G4 S5
    M118 TEST_G4_SECONDS: After 5 seconds at {printer.system_stats.print_time}
    M117 G4 S test complete

[gcode_macro TEST_G4_MILLISECONDS]
description: Test G4 with milliseconds parameter
gcode:
    M118 TEST_G4_MILLISECONDS: Starting at {printer.system_stats.print_time}
    M117 G4 P test starting...
    G4 P5000
    M118 TEST_G4_MILLISECONDS: After 5000ms at {printer.system_stats.print_time}
    M117 G4 P test complete

[gcode_macro TEST_DELAY_BUILTIN]
description: Test Klipper built-in delay
gcode:
    M118 TEST_DELAY_BUILTIN: Starting at {printer.system_stats.print_time}
    M117 Built-in delay test starting...
    {% if printer.configfile.settings.delayed_gcode %}
        # Use delayed_gcode approach
        M118 Using delayed_gcode method
        UPDATE_DELAYED_GCODE ID=test_delay DURATION=5
    {% else %}
        M118 delayed_gcode not available, trying alternative
        # Try direct delay
        G4 P5000
    {% endif %}
    M118 TEST_DELAY_BUILTIN: After delay at {printer.system_stats.print_time}
    M117 Built-in delay test complete

[gcode_macro TEST_LOOP_DELAY]
description: Test multiple small delays in a loop
gcode:
    M118 TEST_LOOP_DELAY: Starting at {printer.system_stats.print_time}
    M117 Loop delay test starting...
    {% for i in range(5) %}
        G4 P1000
        M118 Loop iteration {i+1} at {printer.system_stats.print_time}
    {% endfor %}
    M118 TEST_LOOP_DELAY: Complete at {printer.system_stats.print_time}
    M117 Loop delay test complete

[delayed_gcode test_delay]
gcode:
    M118 DELAYED_GCODE: Triggered at {printer.system_stats.print_time}
    M117 Delayed gcode executed

[gcode_macro RUN_ALL_DELAY_TESTS]
description: Run all delay tests in sequence
gcode:
    M118 === STARTING ALL DELAY TESTS ===
    M118 Current time: {printer.system_stats.print_time}
    
    M118 --- Test 1: G4 S (seconds) ---
    TEST_G4_SECONDS
    
    M118 --- Test 2: G4 P (milliseconds) ---
    TEST_G4_MILLISECONDS
    
    M118 --- Test 3: Built-in delay ---
    TEST_DELAY_BUILTIN
    
    M118 --- Test 4: Loop delay ---
    TEST_LOOP_DELAY
    
    M118 === ALL TESTS COMPLETE ===
    M118 Final time: {printer.system_stats.print_time}

# ============================================================================
# HEAT SOAK MACROS
# ============================================================================

[gcode_macro HEAT_SOAK_CHAMBERX]
description: Original heat soak macro (has timing issues)
gcode:
  {% set soaktemp = params.SOAK_BED_TEMPERATURE|default(100)|int %}
  {% set soaktime = params.SOAK_DURATION_SECONDS|default(900)|int %}
  {% set tick = 30 %}
  {% set num_ticks = (soaktime // tick)|int %}
  M117 Heating bed to {soaktemp}°C...
  M118 Heating bed to {soaktemp}°C...
  M190 S{soaktemp}  ; Wait until bed reaches soaktemp
  {% if printer.toolhead.homed_axes != "xyz" %}
    G28
  {% endif %}
  G90
  G1 Z5 F6000
  M117 Starting heat soak for {soaktime}s...
  M118 Starting heat soak for {soaktime}s...
  ; Count DOWN from soak time
  {% for i in range(num_ticks, 0, -1) %}
    G4 S{tick}
    {% set remaining = i * tick %}
    M117 Soaking... {remaining}s left
    M118 Soaking... {remaining}s left
    G1 X{(i % 2) * 5} F3000
  {% endfor %}
  M117 Heat soak complete.
  M118 Heat soak complete.
  BEEP
  G4 P300
  BEEP
  G4 P600
  BEEP

[gcode_macro HEAT_SOAK_CHAMBER_FIXED]
description: Heat bed to target and soak for chamber warmup (fixed timing)
gcode:
  {% set soaktemp = params.SOAK_BED_TEMPERATURE|default(100)|int %}
  {% set soaktime = params.SOAK_DURATION_SECONDS|default(900)|int %}
  {% set tick = 30 %}
  {% set num_ticks = (soaktime // tick)|int %}
  
  M117 Heating bed to {soaktemp}°C...
  M118 Heating bed to {soaktemp}°C...
  M190 S{soaktemp}  ; Wait until bed reaches soaktemp
  
  {% if printer.toolhead.homed_axes != "xyz" %}
    G28
  {% endif %}
  G90
  G1 Z5 F6000
  
  M117 Starting heat soak for {soaktime}s...
  M118 Starting heat soak for {soaktime}s...
  
  ; Count DOWN from soak time using 1-second delays
  {% for i in range(num_ticks, 0, -1) %}
    {% set remaining = i * tick %}
    M117 Soaking... {remaining}s left
    M118 Soaking... {remaining}s left
    G1 X{(i % 2) * 5} F3000
    
    ; Use loop of 1-second delays instead of single long delay
    {% for second in range(tick) %}
      G4 P1000  ; 1 second delay
    {% endfor %}
  {% endfor %}
  
  M117 Heat soak complete.
  M118 Heat soak complete.
  BEEP
  G4 P300
  BEEP
  G4 P600
  BEEP

[gcode_macro HEAT_SOAK_CHAMBER_RESPONSIVE]
description: Heat bed to target and soak with frequent updates
gcode:
  {% set soaktemp = params.SOAK_BED_TEMPERATURE|default(100)|int %}
  {% set soaktime = params.SOAK_DURATION_SECONDS|default(900)|int %}
  
  M117 Heating bed to {soaktemp}°C...
  M118 Heating bed to {soaktemp}°C...
  M190 S{soaktemp}  ; Wait until bed reaches soaktemp
  
  {% if printer.toolhead.homed_axes != "xyz" %}
    G28
  {% endif %}
  G90
  G1 Z5 F6000
  
  M117 Starting heat soak for {soaktime}s...
  M118 Starting heat soak for {soaktime}s...
  
  ; Count down second by second for better responsiveness
  {% for i in range(soaktime, 0, -1) %}
    ; Update display every 10 seconds
    {% if i % 10 == 0 %}
      M117 Soaking... {i}s left
      M118 Soaking... {i}s left
    {% endif %}
    
    ; Move slightly every 30 seconds for air circulation
    {% if i % 30 == 0 %}
      G1 X{((i // 30) % 2) * 5} F3000
    {% endif %}
    
    G4 P1000  ; 1 second delay
  {% endfor %}
  
  M117 Heat soak complete.
  M118 Heat soak complete.
  BEEP
  G4 P300
  BEEP
  G4 P600
  BEEP